{% extends "base.html" %}

{% block title %}إضافة إعلان جديد{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-3xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
                    إضافة إعلان جديد
                </h1>
                <p class="text-gray-600">
                    املأ النموذج أدناه لإضافة إعلانك الجديد
                </p>
            </div>

            <!-- Form -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <form id="add-ad-form" enctype="multipart/form-data" method="POST" action="/api/ads">
                    <!-- Title -->
                    <div class="mb-6">
                        <label for="title" class="block text-sm font-semibold text-gray-700 mb-2">
                            عنوان الإعلان *
                        </label>
                        <input type="text" id="title" name="title" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="اكتب عنواناً واضحاً ومختصراً لإعلانك">
                    </div>

                    <!-- Category -->
                    <div class="mb-6">
                        <label for="category" class="block text-sm font-semibold text-gray-700 mb-2">
                            القسم *
                        </label>
                        <select id="category" name="category_id" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">اختر القسم</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Description -->
                    <div class="mb-6">
                        <label for="description" class="block text-sm font-semibold text-gray-700 mb-2">
                            الوصف *
                        </label>
                        <textarea id="description" name="description" required rows="5"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="اكتب وصفاً مفصلاً للسلعة أو الخدمة"></textarea>
                    </div>

                    <!-- Price -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="price" class="block text-sm font-semibold text-gray-700 mb-2">
                                السعر *
                            </label>
                            <input type="number" id="price" name="price" required step="0.01" min="0"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="0.00">
                        </div>
                        
                        <div>
                            <label for="currency" class="block text-sm font-semibold text-gray-700 mb-2">
                                العملة *
                            </label>
                            <select id="currency" name="currency" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="USD">دولار أمريكي (USD)</option>
                                <option value="EUR">يورو (EUR)</option>
                                <option value="SAR">ريال سعودي (SAR)</option>
                                <option value="AED">درهم إماراتي (AED)</option>
                                <option value="EGP">جنيه مصري (EGP)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label for="country" class="block text-sm font-semibold text-gray-700 mb-2">
                                الدولة *
                            </label>
                            <select id="country" name="country_id" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر الدولة</option>
                                {% for country in countries %}
                                <option value="{{ country.id }}">{{ country.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label for="state" class="block text-sm font-semibold text-gray-700 mb-2">
                                المنطقة/الولاية
                            </label>
                            <select id="state" name="state_id"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر المنطقة</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="city" class="block text-sm font-semibold text-gray-700 mb-2">
                                المدينة
                            </label>
                            <select id="city" name="city_id"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر المدينة</option>
                            </select>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="contact_phone" class="block text-sm font-semibold text-gray-700 mb-2">
                                رقم الهاتف *
                            </label>
                            <input type="tel" id="contact_phone" name="contact_phone" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="+966 50 123 4567">
                        </div>
                        
                        <div>
                            <label for="contact_email" class="block text-sm font-semibold text-gray-700 mb-2">
                                البريد الإلكتروني
                            </label>
                            <input type="email" id="contact_email" name="contact_email"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="example@email.com">
                        </div>
                    </div>

                    <!-- Images Upload -->
                    <div class="mb-8">
                        <label for="images" class="block text-sm font-semibold text-gray-700 mb-2">
                            صور الإعلان
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="images" name="images" multiple accept="image/*"
                                   class="hidden">
                            <div class="cursor-pointer" onclick="document.getElementById('images').click()">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600 mb-2">اضغط هنا لرفع الصور</p>
                                <p class="text-sm text-gray-500">يمكنك رفع عدة صور (JPG, PNG, GIF)</p>
                            </div>
                        </div>
                        
                        <!-- Image Preview -->
                        <div id="image-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 hidden">
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center">
                        <button type="submit" class="btn-primary px-8 py-3 rounded-lg text-white font-bold text-lg">
                            <i class="fas fa-plus mr-2"></i>
                            نشر الإعلان
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Handle country/state/city dropdowns
    document.getElementById('country').addEventListener('change', function() {
        const countryId = this.value;
        const stateSelect = document.getElementById('state');
        const citySelect = document.getElementById('city');
        
        // Reset state and city
        stateSelect.innerHTML = '<option value="">اختر المنطقة</option>';
        citySelect.innerHTML = '<option value="">اختر المدينة</option>';
        
        if (countryId) {
            fetch(`/api/states/${countryId}`)
                .then(response => response.json())
                .then(states => {
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.id;
                        option.textContent = state.name;
                        stateSelect.appendChild(option);
                    });
                });
        }
    });
    
    document.getElementById('state').addEventListener('change', function() {
        const stateId = this.value;
        const citySelect = document.getElementById('city');
        
        // Reset city
        citySelect.innerHTML = '<option value="">اختر المدينة</option>';
        
        if (stateId) {
            fetch(`/api/cities/${stateId}`)
                .then(response => response.json())
                .then(cities => {
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = city.name;
                        citySelect.appendChild(option);
                    });
                });
        }
    });
    
    // Handle image preview
    document.getElementById('images').addEventListener('change', function() {
        const files = this.files;
        const preview = document.getElementById('image-preview');
        
        if (files.length > 0) {
            preview.classList.remove('hidden');
            preview.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'relative';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}" 
                             class="w-full h-24 object-cover rounded-lg">
                        <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"
                                onclick="this.parentElement.remove()">
                            ×
                        </button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        } else {
            preview.classList.add('hidden');
        }
    });
    
    // Handle form submission
    document.getElementById('add-ad-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>جاري النشر...';
        submitBtn.disabled = true;
        
        fetch('/api/ads', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('تم نشر الإعلان بنجاح!');
                window.location.href = `/ad/${data.ad_id}`;
            } else {
                alert('حدث خطأ أثناء نشر الإعلان. يرجى المحاولة مرة أخرى.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء نشر الإعلان. يرجى المحاولة مرة أخرى.');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
</script>
{% endblock %}